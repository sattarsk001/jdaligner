<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password â€“ SATTAR JD + Resume</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f5fb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .reset-card {
      background: #ffffff;
      max-width: 420px;
      width: 100%;
      padding: 24px 24px 28px;
      border-radius: 16px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    }

    .reset-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    .reset-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .reset-field-group {
      margin-bottom: 12px;
    }

    .reset-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #374151;
    }

    .reset-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }

    .reset-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.25);
    }

    .reset-btn {
      width: 100%;
      margin-top: 12px;
      padding: 8px 10px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #4f46e5;
      color: #ffffff;
    }

    .reset-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .reset-message {
      margin-top: 10px;
      font-size: 13px;
    }

    .reset-message.error {
      color: #b91c1c;
    }

    .reset-message.success {
      color: #15803d;
    }

    .reset-footer {
      margin-top: 16px;
      font-size: 12px;
      color: #6b7280;
    }

    .reset-footer a {
      color: #4f46e5;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="reset-card">
    <h1 class="reset-title">Reset your password</h1>
    <p class="reset-subtitle">
      Choose a new password for your SATTAR JD + Resume account.
    </p>

    <div id="tokenError" class="reset-message error" style="display: none;">
      Invalid or missing reset link. Please request a new password reset from the app.
    </div>

    <form id="resetForm">
      <div class="reset-field-group">
        <label for="newPassword" class="reset-label">New password</label>
        <input
          id="newPassword"
          type="password"
          class="reset-input"
          placeholder="New password"
        />
      </div>

      <div class="reset-field-group">
        <label for="confirmPassword" class="reset-label">Confirm password</label>
        <input
          id="confirmPassword"
          type="password"
          class="reset-input"
          placeholder="Confirm password"
        />
      </div>

      <button id="resetSubmitBtn" type="submit" class="reset-btn">
        Update password
      </button>

      <div id="resetMessage" class="reset-message" style="display: none;"></div>
    </form>

    <div class="reset-footer">
      <a href="index.html">Back to login</a>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    const tokenErrorEl = document.getElementById("tokenError");
    const resetForm = document.getElementById("resetForm");
    const newPasswordInput = document.getElementById("newPassword");
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const resetMessageEl = document.getElementById("resetMessage");
    const resetSubmitBtn = document.getElementById("resetSubmitBtn");

    // If no token in URL, show error and disable form
    if (!token) {
      tokenErrorEl.style.display = "block";
      if (resetSubmitBtn) resetSubmitBtn.disabled = true;
    }

    function showMessage(text, isError) {
      if (!resetMessageEl) return;
      resetMessageEl.textContent = text;
      resetMessageEl.style.display = "block";
      resetMessageEl.classList.toggle("error", !!isError);
      resetMessageEl.classList.toggle("success", !isError);
    }

    if (resetForm) {
      resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!token) {
          showMessage("Reset link is invalid. Please request a new one.", true);
          return;
        }

        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        if (!newPassword || !confirmPassword) {
          showMessage("Please fill in both password fields.", true);
          return;
        }

        if (newPassword.length < 8) {
          showMessage("Password should be at least 8 characters long.", true);
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage("Passwords do not match.", true);
          return;
        }

        resetSubmitBtn.disabled = true;
        showMessage("", false);
        resetMessageEl.style.display = "none";

        try {
          const resp = await fetch(`${API_BASE}/auth/reset-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              token: token,
              new_password: newPassword,
              confirm_password: confirmPassword,
            }),
          });

          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            const detail = data && data.detail ? data.detail : "Failed to reset password.";
            showMessage(detail, true);
            resetSubmitBtn.disabled = false;
            return;
          }

          showMessage("Your password has been updated. You can now log in with the new password.", false);

          // Optionally clear fields
          newPasswordInput.value = "";
          confirmPasswordInput.value = "";

        } catch (err) {
          console.error("Error calling /auth/reset-password:", err);
          showMessage("Something went wrong. Please try again in a moment.", true);
          resetSubmitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
